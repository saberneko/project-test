<template>
<div class="crop-wrap" v-touch:pan="wrapPan" v-touch:press="updateRec" v-touch-options:pan="{ domEvents: true, threshold: 0 }" >
  <div class="shadow-box">
    <img :src="img" class="shadow-img">
  </div>
  <div class="crop-box" v-touch:pan="boxPan" v-touch-options:pan="{ domEvents: true, threshold: 0 }" :class="{'show': showBox}">
    <span class="drag-point point-lt" v-touch:pan="pointPan('drag-lt', $event)" ></span>
    <span class="drag-point point-lb" v-touch:pan="pointPan('drag-lb', $event)" ></span>
    <span class="drag-point point-rt" v-touch:pan="pointPan('drag-rt', $event)" ></span>
    <span class="drag-point point-rb" v-touch:pan="pointPan('drag-rb', $event)" ></span>
  </div>
</div>
</template>

<script>
/* eslint-disable */
export default {
  props: {
    radio: {
      default: 16 / 10
    },
    img: {
      default: ''
    }
  },
  data () {
    return {
      rec: { w: 0, h: 0, l: 0, t: 0 },
      pl: 0,
      pt: 0,
      action: '',
      actionPoint: { x: 0, y: 0 },
      referPoint: { x: 0, y: 0 },
      $rec: null
    }
  },
  computed: {
    showBox () {
      return this.rec.w && this.rec.h
    },
    isMobile () {
      // console.info('ontouchstart' in window)
      return 'ontouchstart' in window
    }
  },
  watch: {
    rec: {
      handler () {
        this.drawRec()
      },
      deep: true
    }
  },
  ready () {
    this.$rec = this.$el.querySelector('.crop-box')
    this.$img = this.$el.querySelector('.shadow-img')
    this.$shadowBox = this.$el.querySelector('.shadow-box')

    // 支持移动设备
    if ('ontouchstart' in window) {
      window.addEventListener('touchend', this.disableDrag)
    } else {
      window.addEventListener('mouseup', this.disableDrag)
      window.addEventListener('mousemove', this.updateRec)
    }

    this.$on('imgSizeChange', function (o) {
      this.$img.style.width = `${o.w}px`
      this.$img.style.height = `${o.h}px`
    })
  },
  beforeDestory () {
    if ('ontouchstart' in window) {
      window.removeEventListener('touchend', this.disableDrag)
    } else {
      // 支持移动设备
      window.removeEventListener('mouseup', this.disableDrag)
      window.removeEventListener('mousemove', this.updateRec)
    }
  },
  methods: {
    getLeft (el) {
      let left = el.offsetLeft
      let parent = el.offsetParent

      while (parent) {
        left += parent.offsetLeft
        parent = parent.offsetParent
      }
      return left
    },
    getTop (el) {
      let top = el.offsetTop
      let parent = el.offsetParent

      while (parent) {
        top += parent.offsetTop
        parent = parent.offsetParent
      }
      return top
    },
    initAction (name, x, y) {
      this.action = name
      this.pl = this.getLeft(this.$el)
      this.pt = this.getTop(this.$el)
      this.actionPoint = { x, y }
      this.referPoint = { x: this.rec.l, y: this.rec.t }

      if (name === 'drag-lt') {
        this.referPoint = { x: this.rec.l + this.rec.w, y: this.rec.t + this.rec.h }
      } else if (name === 'drag-lb') {
        this.referPoint = { x: this.rec.l + this.rec.w, y: this.rec.t }
      } else if (name === 'drag-rt') {
        this.referPoint = { x: this.rec.l, y: this.rec.t + this.rec.h }
      } else if (name === 'drag-rb') {
        this.referPoint = { x: this.rec.l, y: this.rec.t }
      }
    },
    pointMouseDown (name, e) {
      console.info('pointMouseDown')
      this.initAction(name, e.pageX, e.pageY)
      e.stopPropagation()
    },
    pointPan (name, e) {
      let { srcEvent, center, deltaX, deltaY } = e,
        { x, y } = center

      console.info('pointPan:' + name, e, this.actionPoint, x, y)

      e.pageX = x + deltaX
      e.pageY = y + deltaY
      this.initAction(name, x, y)
      this.isMobile && this.updateRec(e)

      srcEvent.stopPropagation()
    },
    boxPan (e) {
      let { srcEvent, center, deltaX, deltaY, pointers } = e,
        [ point ] = pointers, // point have the pageX, pageY you need
        { x, y } = center

      e.pageX = x + deltaX
      e.pageY = y + deltaY

      // console.info('boxPan', e, center, this.actionPoint, deltaX, deltaY)
      this.initAction('move', point.pageX, point.pageY)

      this.isMobile && this.updateRec(e)
      srcEvent.stopPropagation()
    },
    boxMouseDown (e) {
      console.info('boxMouseDown', e.pageX, e.pageY)
      this.initAction('move', e.pageX, e.pageY)
      e.stopPropagation()
    },
    wrapPan (e) {
      let { srcEvent, center, deltaX, deltaY } = e,
        { x, y } = center

      console.info('wrapPan', e, this.actionPoint, x, y)

      if (this.rec.w && this.rec.h) {
        return
      }

      console.info('not showing')

      e.pageX = x + deltaX
      e.pageY = y + deltaY

      this.initAction('cross', x, y)

      this.rec = {
        w: 0,
        h: 0,
        l: e.pageX - this.pl,
        t: e.pageY - this.pt
      }

      // this.isMobile && this.updateRec(e)

      srcEvent.stopPropagation()
    },
    wrapMouseDown (e) {
      if (this.rec.w && this.rec.h) {
        return
      }
      this.initAction('cross', e.pageX, e.pageY)
      this.rec = {
        w: 0,
        h: 0,
        l: e.pageX - this.pl,
        t: e.pageY - this.pt
      }
      e.stopPropagation()
    },
    disableDrag () {
      if (this.action) {
        this.action = ''
        this.$dispatch('selectEnd')
      }
    },
    clearRec () {
      this.action = ''
      this.rec = { w: 0, h: 0, l: 0, t: 0 }
    },
    updateRec (e) {
      if (!this.action || !this.$el) {
        return
      }

      let elWidth = this.$el.offsetWidth
      let elHeight = this.$el.offsetHeight
      let dx = !this.isMobile ? (e.pageX - this.actionPoint.x) : e.deltaX
      let dy = !this.isMobile ? (e.pageY - this.actionPoint.y) : e.deltaY
      let x = e.pageX
      let y = e.pageY
      let w = 0
      let h = 0
      let t = 0
      let l = 0

      if (this.isMobile) {
        console.info('start update', e)
        // dx = e.center.x - this.actionPoint.x
        // dy = e.center.y - this.actionPoint.y
      }

      console.info(dx, dy, this.referPoint)

      if (dx === 0 && dy === 0) {
        return
      }

      if (this.action === 'move') {
        t = dy + this.referPoint.y
        l = dx + this.referPoint.x

        if (t <= 0) {
          t = 0
        } else if (t + this.rec.h >= elHeight) {
          t = elHeight - this.rec.h
        }

        if (l <= 0) {
          l = 0
        } else if (l + this.rec.w >= elWidth) {
          l = elWidth - this.rec.w
        }

        this.rec.l = l
        this.rec.t = t
      } else if (this.action === 'cross') {
        if (dx > 0 && dy > 0) {
          w = dx + this.rec.l >= elWidth ? elWidth - this.rec.l : dx
          h = w / this.radio

          if (h + this.rec.t > elHeight) {
            h = elHeight - this.rec.t
            w = h * this.radio
          }
          this.rec.w = w
          this.rec.h = h
        } else if (dx > 0 && dy < 0) {
          w = dx + this.referPoint.x >= elWidth ? elWidth - this.referPoint.x : dx
          h = w / this.radio

          if (h >= this.referPoint.y) {
            h = this.referPoint.y
            w = h * this.radio
          }

          this.rec.t = this.referPoint.y - h
          this.rec.w = w
          this.rec.h = h
        } else if (dx < 0 && dy < 0) {
          w = dx + this.referPoint.x <= 0 ? this.referPoint.x : -dx
          h = w / this.radio

          if (h >= this.referPoint.y) {
            h = this.referPoint.y
            w = h * this.radio
          }

          this.rec.t = this.referPoint.y - h
          this.rec.l = this.referPoint.x - w
          this.rec.w = w
          this.rec.h = h
        } else if (dx < 0 && dy > 0) {
          w = dx + this.referPoint.x <= 0 ? this.referPoint.x : -dx
          h = w / this.radio

          if (h + this.referPoint.y >= elHeight) {
            h = elHeight - this.referPoint.y
            w = h * this.radio
          }

          this.rec.l = this.referPoint.x - w
          this.rec.w = w
          this.rec.h = h
        }
      } else if (this.action === 'drag-lt' || this.action === 'drag-rt' || this.action === 'drag-lb' || this.action === 'drag-rb') {
        console.info('here for drag point')
        w = x - (this.referPoint.x + this.pl)
        h = y - (this.referPoint.y + this.pt)
        if (w < 0 && h < 0) {
          w = w * -1 >= this.referPoint.x ? this.referPoint.x : w * -1
          h = w / this.radio

          if (h >= this.referPoint.y) {
            h = this.referPoint.y
            w = h * this.radio
          }
          this.rec.l = this.referPoint.x - w
          this.rec.t = this.referPoint.y - h
        } else if (w < 0 && h > 0) {
          w = w * -1 >= this.referPoint.x ? this.referPoint.x : w * -1
          h = w / this.radio

          if (h >= elHeight - this.referPoint.y) {
            h = elHeight - this.referPoint.y
            w = h * this.radio
          }
          this.rec.l = this.referPoint.x - w
          this.rec.t = this.referPoint.y
        } else if (w > 0 && h < 0) {
          w = w >= elWidth - this.referPoint.x ? elWidth - this.referPoint.x : w
          h = w / this.radio

          if (h >= this.referPoint.y) {
            h = this.referPoint.y
            w = h * this.radio
          }
          this.rec.l = this.referPoint.x
          this.rec.t = this.referPoint.y - h
        } else if (w > 0 && h > 0) {
          w = w >= elWidth - this.referPoint.x ? elWidth - this.referPoint.x : w
          h = w / this.radio

          if (h >= elHeight - this.referPoint.y) {
            h = elHeight - this.referPoint.y
            w = h * this.radio
          }
          this.rec.l = this.referPoint.x
          this.rec.t = this.referPoint.y
        }

        this.rec.w = w
        this.rec.h = h
      }
      this.$dispatch('selectChange')
    },
    drawRec () {
      if (!this.$rec) {
        this.$rec = this.$el.querySelector('.crop-box')
      }

      this.$rec.setAttribute('style',
          `width:${this.rec.w}px;height:${this.rec.h}px;
          left:${this.rec.l}px;top:${this.rec.t}px;z-index:2;`)
      this.$shadowBox.setAttribute('style',
          `width:${this.rec.w}px;height:${this.rec.h}px;
          left:${this.rec.l}px;top:${this.rec.t}px;z-index:1;`)
      this.$img.style.left = `-${this.rec.l}px`
      this.$img.style.top = `-${this.rec.t}px`
    }
  }
}
</script>

<style lang="stylus" scoped>
.crop-wrap
  width: 100%
  height: 100%
  position: absolute
  top: 0
  left: 0
  z-index: 10
  cursor: crosshair

.crop-box
  position: absolute
  display: none
  top: 0
  left: 0
  width: 0
  height: 0
  cursor: move
  border: 1px solid #fff

.crop-box.show
  display: block

.drag-point
  display: inline-block
  width: 10px
  height: 10px
  border: 1px solid #fff
  position: absolute

.point-lt
  top: -10px
  left: -10px
  cursor: nw-resize

.point-lb
  left: -10px
  bottom: -10px
  cursor: sw-resize

.point-rt
  right: -10px
  top: -10px
  cursor: ne-resize

.point-rb
  right: -10px
  bottom: -10px
  cursor: se-resize

.shadow-box
  position: absolute
  top: 0
  left: 0
  overflow: hidden

.shadow-img
  position: absolute
  top: 0
  left: 0

.shadow-box::selection, .shadow-img::selection
  background-color: transparent

</style>
